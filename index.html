<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="csrf-token" content="<?php echo $_SESSION['csrf_token']; ?>">
    <title>Crear Anuncio - Trestiq Marketplace</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body id="page-top">
    <div id="wrapper">
        
        
              <div id="content-wrapper" class="d-flex flex-column">
<div id="content">
<nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
<button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
<i class="fa fa-bars"></i>
</button>
<div class="d-flex align-items-center">
<i class="fas fa-plus-circle fa-2x text-primary mr-2"></i>
<div>
<h1 class="h3 mb-0 text-gray-800">Crear Nuevo Anuncio</h1>
<small class="text-muted">Sistema de Publicación de Activos Digitales</small>
</div>
</div>
<div class="ml-auto d-flex align-items-center">
<span class="mr-2 d-none d-lg-inline text-gray-600 small">ID: <?php echo uniqid('LISTING-'); ?></span>
<span class="badge badge-warning">
<i class="fas fa-save mr-1"></i>
Borrador
</span>
</div>
</nav>

<div class="container-fluid">
<div class="row justify-content-center">
<div class="col-lg-8">
<div class="card mb-4">
<div class="card-body">
<div class="progress mb-3">
<div class="progress-bar" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
</div>
<div class="d-flex justify-content-between">
<span class="badge badge-primary step-badge" id="stepBadge1">Información Básica</span>
<span class="badge badge-light step-badge" id="stepBadge2">Métricas</span>
<span class="badge badge-light step-badge" id="stepBadge3">Monetización</span>
<span class="badge badge-light step-badge" id="stepBadge4">Configuración</span>
</div>
</div>
</div>

<form id="listingForm" enctype="multipart/form-data">
<input type="hidden" name="csrf_token" value="<?php echo $_SESSION['csrf_token']; ?>">

<!-- Paso 1: Información Básica -->
<div class="step-content" id="step1">
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex align-items-center">
            <i class="fas fa-info-circle fa-2x text-primary mr-2"></i>
            <h6 class="m-0 font-weight-bold text-primary">Información Básica</h6>
        </div>
        <div class="card-body">
            <!-- Título y Descripción -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-heading mr-2"></i>Detalles Principales
                </div>
                <div class="form-group">
                    <label>Título del Activo</label>
                    <input type="text" class="form-control form-control-lg" name="title" required
                        minlength="20" maxlength="200"
                        placeholder="Ej: Sitio Web de Comercio Electrónico Rentable">
                    <small class="help-text">
                        <i class="fas fa-info-circle mr-1"></i>
                        Un título claro y descriptivo ayudará a atraer compradores potenciales
                    </small>
                </div>

                <div class="form-group mb-0">
                    <label>Descripción Detallada</label>
                    <textarea class="form-control" name="description" rows="4" required
                        minlength="50" maxlength="900"
                        placeholder="Describe detalladamente tu activo digital..."></textarea>
                    <div class="d-flex justify-content-between">
                        <small class="help-text">
                            <i class="fas fa-info-circle mr-1"></i>
                            Mínimo 50 caracteres, máximo 900
                        </small>
                        <small class="help-text">
                        </small>
                    </div>
                </div>
            </div>

            <!-- Tipo de Propiedad y Categoría -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-building mr-2"></i>Tipo y Categoría
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Tipo de Propiedad</label>
                            <select class="form-control" name="property_type" id="propertyType" required>
                                <option value="">Seleccionar tipo...</option>
                                <option value="1">Sitio Web</option>
                                <option value="2">Canal de YouTube</option>
                                <option value="3">Aplicación</option>
                                <option value="4">E-commerce</option>
                                <option value="5">SaaS</option>
                                <option value="6">Redes Sociales</option>
                                <option value="7">Amazon Store</option>
                            </select>
                        </div>
                    </div>
                 <div class="col-md-6">
<div class="form-group">
<label>Category</label>
<select class="form-control" name="category_id" required>
<option value="">Select a category...</option>
<option value="1">Technology</option>
<option value="2">Education</option>
<option value="3">Finance</option>
<option value="4">Entertainment</option>
<option value="5">Health and Fitness</option>
<option value="6">Travel and Lifestyle</option>
<option value="7">Gaming</option>
<option value="8">Fashion and Beauty</option>
<option value="9">Business and Marketing</option>
<option value="10">Food and Cooking</option>
<option value="11">Anime</option>
</select>
</div>
</div>


                </div>
            </div>

            <!-- URL Container -->
            <div class="section-card">
                <div class="section-title">
                    <i class="fas fa-link mr-2"></i>URL del Activo
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="urlContainer">
                            <!-- El contenedor para el campo URL dinámico -->
                        </div>
                    </div>
                </div>
            </div>

<!-- Información Temporal y Precio -->
<div class="section-card">
    <div class="section-title">
        <i class="fas fa-clock mr-2"></i>Detalles Temporales y Precio
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="form-group">
                <label>Fecha de Creación</label>
                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text">
                            <i class="fas fa-calendar-alt"></i>
                        </span>
                    </div>
                    <input type="date" class="form-control" name="creation_date" required>
                </div>
                <small class="help-text">Fecha en que se creó originalmente la propiedad</small>
            </div>
        </div>
        <div class="col-md-6">
            <div class="form-group">
                <label>Precio de Venta (USD)</label>
                <div class="input-group precio-venta">
                    <div class="input-group-prepend">
                        <span class="input-group-text simbolo-moneda">
                            <i class="fas fa-dollar-sign"></i>
                        </span>
                    </div>
                    <input type="text" class="form-control precio" name="price" required min="0" step="0.01" placeholder="Ej: 4500.00">
                </div>
                <small class="help-text">Ingrese el precio de venta deseado para el activo</small>
            </div>
        </div>
    </div>
</div>

</div>
</div>
</div>


<!-- Paso 2: Métricas -->
        <div class="step-content" id="step2">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-chart-line mr-2"></i>Métricas del Activo
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Métricas Financieras -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-dollar-sign mr-2"></i>Métricas Financieras
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ingresos Mensuales (USD)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="number" class="form-control" name="monthly_revenue" min="0" required/>
                                    </div>
                                    <small class="form-text text-muted">Promedio de ingresos mensuales de los últimos 6 meses</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ingresos Anuales (USD)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="number" class="form-control" name="annual_revenue" min="0" required/>
                                    </div>
                                    <small class="form-text text-muted">Total de ingresos en los últimos 12 meses</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Beneficio Mensual (USD)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="number" class="form-control" name="monthly_profit" min="0" required/>
                                    </div>
                                    <small class="form-text text-muted">Beneficio neto mensual después de todos los gastos</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>ROI (%)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <input type="number" class="form-control" name="roi" min="0" step="0.01" required/>
                                    </div>
                                    <small class="form-text text-muted">Retorno de inversión calculado en porcentaje</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Múltiplo de Ingresos</label>
                                    <input type="number" class="form-control" name="revenue_multiple" readonly step="0.01"/>
                                    <small class="form-text text-muted">
                                        Calculado automáticamente (Precio ÷ Ingresos mensuales)
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Múltiplo de Beneficios</label>
                                    <input type="number" class="form-control" name="profit_multiple" readonly step="0.01"/>
                                    <small class="form-text text-muted">
                                        Calculado automáticamente (Precio ÷ Beneficio mensual)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas de Audiencia -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-users mr-2"></i>Métricas de Audiencia y Engagement
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tráfico Mensual Promedio</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-users"></i></span>
                                        </div>
                                        <input type="number" class="form-control" name="monthly_visits" min="0" required/>
                                    </div>
                                    <small class="form-text text-muted">Promedio de visitas mensuales de los últimos 3 meses</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tasa de Conversión (%)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <input type="number" class="form-control" name="conversion_rate" min="0" max="100" step="0.01" required/>
                                    </div>
                                    <small class="form-text text-muted">Porcentaje de visitantes que realizan una acción deseada</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tiempo Promedio en Sitio (minutos)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-clock"></i></span>
                                        </div>
                                        <input type="number" class="form-control" name="avg_time_on_site" min="0" step="0.1" required/>
                                    </div>
                                    <small class="form-text text-muted">Tiempo promedio que los usuarios pasan en el sitio</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tasa de Rebote (%)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <input type="number" class="form-control" name="bounce_rate" min="0" max="100" step="0.01" required/>
                                    </div>
                                    <small class="form-text text-muted">Porcentaje de visitantes que abandonan sin interactuar</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas de Crecimiento -->
                    <div class="section-card">
                        <div class="section-title">
                            <i class="fas fa-chart-line mr-2"></i>Métricas de Crecimiento
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tasa de Crecimiento Mensual (%)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <input type="number" class="form-control" name="monthly_growth_rate" min="0" step="0.01" required/>
                                    </div>
                                    <small class="form-text text-muted">Crecimiento promedio mensual de usuarios/ingresos</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Usuarios Recurrentes (%)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">%</span>
                                        </div>
                                        <input type="number" class="form-control" name="recurring_users" min="0" max="100" step="0.01" required/>
                                    </div>
                                    <small class="form-text text-muted">Porcentaje de usuarios que regresan mensualmente</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Antigüedad del Activo (meses)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-history"></i></span>
                                        </div>
                                        <input type="number" class="form-control" name="asset_age" min="0" required/>
                                    </div>
                                    <small class="form-text text-muted">Tiempo desde que el activo fue creado</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Tiempo de Monetización (meses)</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                        </div>
                                        <input type="number" class="form-control" name="monetization_age" min="0" required/>
                                    </div>
                                    <small class="form-text text-muted">Tiempo desde que comenzó a generar ingresos</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

       <!-- Paso 3: Monetización -->
<div class="step-content" id="step3" style="display: none;">
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-dollar-sign mr-2"></i>Detalles de Monetización
            </h6>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>Tipos de Monetización</label>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input" id="adsense" name="monetization_types[]" value="adsense">
                    <label class="custom-control-label" for="adsense">
                        <i class="fab fa-google mr-2"></i>Google AdSense
                    </label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input" id="sponsorships" name="monetization_types[]" value="sponsorships">
                    <label class="custom-control-label" for="sponsorships">
                        <i class="fas fa-handshake mr-2"></i>Patrocinios
                    </label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input" id="affiliate" name="monetization_types[]" value="affiliate">
                    <label class="custom-control-label" for="affiliate">
                        <i class="fas fa-link mr-2"></i>Afiliados
                    </label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input" id="products" name="monetization_types[]" value="products">
                    <label class="custom-control-label" for="products">
                        <i class="fas fa-shopping-cart mr-2"></i>Productos
                    </label>
                </div>
                <div class="custom-control custom-checkbox mb-2">
                    <input type="checkbox" class="custom-control-input" id="subscriptions" name="monetization_types[]" value="subscriptions">
                    <label class="custom-control-label" for="subscriptions">
                        <i class="fas fa-sync mr-2"></i>Suscripciones
                    </label>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- Paso 4: Configuración -->
        <div class="step-content" id="step4" style="display: none;">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-cog mr-2"></i>Configuración del Anuncio
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Idioma del Anuncio</label>
                                <select class="form-control" name="listing_language" required>
                                    <option value="es">Español</option>
                                    <option value="en">Inglés</option>
                                    <option value="fr">Francés</option>
                                    <option value="de">Alemán</option>
                                    <option value="pt">Portugués</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Duración de Visibilidad (días)</label>
                                <input type="number" class="form-control" name="visibility_days" value="180" min="1" max="365" required>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Idioma del Negocio</label>
                                <select class="form-control" name="business_language" required>
                                    <option value="es">Español</option>
                                    <option value="en">Inglés</option>
                                    <option value="fr">Francés</option>
                                    <option value="de">Alemán</option>
                                    <option value="pt">Portugués</option>
                                    <option value="other">Otro</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Imágenes del Activo</label>
                        <div class="custom-file">
                            <input type="file" class="custom-file-input" name="asset_images[]" multiple accept="image/jpeg,image/png" data-max-files="5" data-max-size="5242880">
                            <label class="custom-file-label">Seleccionar archivos</label>
                        </div>
                        <div class="image-preview mt-3" id="imagePreview"></div>
                        <small class="text-muted">
                            Máximo 5 imágenes (JPG, PNG). Tamaño máximo por imagen: 5MB
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Botones de navegación -->
        <div class="d-flex justify-content-between mb-5">
            <button type="button" class="btn btn-secondary" id="prevStepBtn" style="display: none;">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <div>
                <button type="button" class="btn btn-light mr-2" id="saveDraftBtn">
                    <i class="fas fa-save"></i> Guardar Borrador
                </button>
                <button type="button" class="btn btn-primary" id="nextStepBtn">
                    Siguiente <i class="fas fa-arrow-right"></i>
                </button>
            </div>
         </div>

    <script src="/wp-content/themes/blocksy-child/trestiq-auth/assets/vendor/jquery/jquery.min.js"></script>
    <script src="/wp-content/themes/blocksy-child/trestiq-auth/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

   <!-- <script>

const TrestiqFormSteps = {
    currentStep: 1,
    totalSteps: 4,
    categories: [], // Agregar esta propiedad

    // Agregar la nueva función aquí
    loadTaxonomyCategories: async function() {
    try {
        const response = await $.get('/wp-content/themes/blocksy-child/trestiq-auth/includes/TrestiqCore/Listings/taxonomy.php', {
            action: 'get_categories'
        });
        if (response.success) {
            this.categories = response.data;
        }
    } catch (error) {
        console.error('Error cargando categorías:', error);
    }
},

    
    // Patrones de validación para URLs
    validationPatterns: {
    '1': { // website
        pattern: /^(https?:\/\/)?([\da-z\.-]+)\.([a-z\.]{2,6})([\/\w \.-]*)\/?$/,
        name: 'Sitio Web',
        examples: [
            'https://www.tusitio.com',
            'http://tusitio.com'
        ]
    },
    '2': { // youtube_channel
        pattern: /^https?:\/\/(www\.)?(youtube\.com|youtu\.be)\/@?[\w-]+/,
        name: 'YouTube',
        examples: [
            'https://youtube.com/@nombrecanal',
            'https://www.youtube.com/@nombrecanal'
        ]
    },
    '3': { // app
        pattern: /^https?:\/\/(play\.google\.com|apps\.apple\.com)/,
        name: 'Aplicación',
        examples: [
            'https://play.google.com/store/apps/details?id=com.tuapp',
            'https://apps.apple.com/app/tuapp'
        ]
    },
    '4': { // ecommerce
        pattern: /^https?:\/\/(shopify\.com|woocommerce\.com|magento\.com)/,
        name: 'E-commerce',
        examples: [
            'https://tutienda.shopify.com',
            'https://tutienda.woocommerce.com'
        ]
    },
    '5': { // saas
        pattern: /^https?:\/\//,
        name: 'SaaS',
        examples: [
            'https://tusaas.com',
            'https://app.tusaas.com'
        ]
    },
    '6': { // social_media
        pattern: /^https?:\/\/(facebook\.com|instagram\.com|twitter\.com|tiktok\.com)/,
        name: 'Social Media',
        examples: [
            'https://instagram.com/usuario',
            'https://facebook.com/pagina'
        ]
    },
    '7': { // amazon_store
        pattern: /^https?:\/\/(www\.)?(amazon\.com|amazon\.[a-z]{2,3})\/.+/,
        name: 'Amazon Store',
        examples: [
            'https://amazon.com/shop/nombretienda',
            'https://www.amazon.com/shop/nombretienda'
        ]
    }
},

    init: async function() {
        await this.loadTaxonomyCategories(); // Modificar init para que sea async
        this.bindEvents();
        this.showCurrentStep();
        this.setupImageValidation();
        this.setupRealTimeValidation();
        this.setupImagePreview();
    $('input[name="revenue_multiple"], input[name="profit_multiple"]').prop('readonly', true);

    // Validación inicial de métricas si hay valores precargados
    const hasEmployees = $('#has_employees').is(':checked');
    const maxMultiple = hasEmployees ? 35 : 25;
    this.updateMultipleValidation(maxMultiple);

    // Limpiar formulario si fue enviado previamente
    if (sessionStorage.getItem('formSubmitted')) {
        this.resetForm();
    }
},

    resetForm: function() {
        $('#listingForm')[0].reset();
        $('#listingForm input, #listingForm textarea').removeClass('is-valid is-invalid');
        $('.feedback-message, .feedback-container').remove();
        $('#imagePreview').empty();
        $('input[name="revenue_multiple"], input[name="profit_multiple"]').val('');
        $('#employee_documentation').hide();
        $('.url-verification-section').remove();
        sessionStorage.removeItem('formSubmitted');
    },

    bindEvents: function() {
        $('#nextStepBtn').on('click', () => this.nextStep());
        $('#prevStepBtn').on('click', () => this.previousStep());
        $('#saveDraftBtn').on('click', () => this.saveDraft());
        $('#propertyType').on('change', (e) => this.handlePropertyTypeChange(e));
        
        $('input, select, textarea').on('change', function() {
            $(this).removeClass('is-invalid');
            if ($(this).prop('required') && !$(this).val()) {
                $(this).addClass('is-invalid');
            }
        });
    },

   handlePropertyTypeChange: function(event) {
    const categoryId = $(event.target).val();
    $('#urlContainer').empty();

    if (categoryId && categoryId !== '') {
        const config = this.validationPatterns[categoryId];
        if (!config) return;

        const urlFieldMap = {
            '1': 'website_url',
            '2': 'channel_url',
            '3': 'app_store_url',
            '4': 'ecommerce_url',
            '5': 'saas_url',
            '6': 'social_media_url',
            '7': 'amazon_store_url'
        };

        const urlField = urlFieldMap[categoryId];

        const urlSection = $(
            '<div class="card mt-3 url-verification-section">' +
            '<div class="card-body">' +
            '<div class="form-group">' +
            '<label>URL de ' + config.name + '</label>' +
            '<input type="url" class="form-control" name="' + urlField + '" ' +
            'required placeholder="' + config.examples[0] + '"/>' +
            '<small class="text-muted">Ingresa la URL completa</small>' +
            '</div>' +
            '</div>' +
            '</div>'
        );

        $('#urlContainer').append(urlSection);
        this.setupUrlValidation(categoryId);
    }
},



   setupRealTimeValidation: function() {
    this.setupMetricsValidation();
    this.setupTitleValidation();
    this.setupDescriptionValidation();
    this.setupUrlValidation();
    this.setupEmployeeValidation();
    this.setupPriceFormatting(); // Agregar esta línea
},

// Agregar esta nueva función
setupPriceFormatting: function() {
    $('input[name="price"]').on('input', function() {
        // Obtener el valor sin formato
        let valor = this.value.replace(/\D/g, '');

        // Convertir a número y formatear con separadores
        if (valor !== '') {
            // Dividir en parte entera y decimal
            let numero = parseFloat(valor) / 100;

            // Formatear con separadores de miles y decimales
            this.value = numero.toLocaleString('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
    });
},


    setupMetricsValidation: function() {
        const inputs = 'input[name="monthly_revenue"], input[name="monthly_profit"], input[name="price"]';
        $(inputs).on('input', () => {
            const hasEmployees = $('#has_employees').is(':checked');
            const maxMultiple = hasEmployees ? 35 : 25;
            this.updateMultipleValidation(maxMultiple);
        });
    },

    setupEmployeeValidation: function() {
        $('#has_employees').on('change', () => {
            const hasEmployees = $('#has_employees').is(':checked');
            $('#employee_documentation, #employee_count_section').toggle(hasEmployees);
            const maxMultiple = hasEmployees ? 35 : 25;
            this.updateMultipleValidation(maxMultiple);
        });
    },

    setupTitleValidation: function() {
        $('input[name="title"]').on('input', function() {
            const min = 20;
            const max = 200;
            const current = $(this).val().length;

            $(this).next('.feedback-container').remove();
            $(this).after(`<div class="feedback-container text-muted">${current}/${max} caracteres (mínimo ${min})</div>`);

            if (current < min || current > max) {
                $(this).removeClass('is-valid').addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid').addClass('is-valid');
            }
        });
    },

    setupDescriptionValidation: function() {
        $('textarea[name="description"]').on('input', function() {
            const min = 50;
            const max = 900;
            const current = $(this).val().length;

            $(this).next('.feedback-container').remove();
            $(this).after(`<div class="feedback-container text-muted">${current}/${max} caracteres (mínimo ${min})</div>`);

            if (current < min || current > max) {
                $(this).removeClass('is-valid').addClass('is-invalid');
                if (current > max) {
                    $(this).val($(this).val().substring(0, max));
                }
            } else {
                $(this).removeClass('is-invalid').addClass('is-valid');
            }
        });
    },

    setupUrlValidation: function(categoryId) {
    if (!categoryId) return;

    const config = this.validationPatterns[categoryId];
    if (!config) return;

    const urlFieldMap = {
        '1': 'website_url',
        '2': 'channel_url',
        '3': 'app_store_url',
        '4': 'ecommerce_url',
        '5': 'saas_url',
        '6': 'social_media_url',
        '7': 'amazon_store_url'
    };

    const urlField = urlFieldMap[categoryId];
    $(`input[name="${urlField}"]`).on('input', (e) => {
        const url = $(e.target).val().toLowerCase();
        $(e.target).next('.feedback-message').remove();

        if (url && !config.pattern.test(url)) {
            $(e.target).removeClass('is-valid').addClass('is-invalid');
            $(e.target).after(`
                <div class="feedback-message invalid-feedback">
                    <div class="mb-2">URL de ${config.name} inválida</div>
                    <div class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        Formatos válidos:
                        <ul>
                            ${config.examples.map(ex => `<li>${ex}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `);
        } else if (url) {
            $(e.target).removeClass('is-invalid').addClass('is-valid');
            $(e.target).after('<div class="feedback-message valid-feedback"><i class="fas fa-check"></i> URL válida</div>');
        }
    });
},

    updateMultipleValidation: function(maxMultiple) {
        const price = parseFloat($('input[name="price"]').val()) || 0;
        const profit = parseFloat($('input[name="monthly_profit"]').val()) || 0;
        const revenue = parseFloat($('input[name="monthly_revenue"]').val()) || 0;
        const priceInput = $('input[name="price"]');
        const profitInput = $('input[name="monthly_profit"]');
        const revenueInput = $('input[name="monthly_revenue"]');

        $('.feedback-message').remove();

        if (profit > revenue) {
            profitInput.removeClass('is-valid').addClass('is-invalid');
            profitInput.after('<div class="feedback-message invalid-feedback">El beneficio mensual no puede ser mayor que los ingresos mensuales</div>');
            $('input[name="revenue_multiple"], input[name="profit_multiple"]').val('');
            return false;
        }

        if (price <= 0 || profit <= 0 || revenue <= 0) {
            if (price <= 0) {
                priceInput.removeClass('is-valid').addClass('is-invalid');
                priceInput.after('<div class="feedback-message invalid-feedback">El precio debe ser mayor que cero</div>');
            }
            if (revenue <= 0) {
                revenueInput.removeClass('is-valid').addClass('is-invalid');
                revenueInput.after('<div class="feedback-message invalid-feedback">Los ingresos deben ser mayores que cero</div>');
            }
            if (profit <= 0) {
                profitInput.removeClass('is-valid').addClass('is-invalid');
                profitInput.after('<div class="feedback-message invalid-feedback">El beneficio debe ser mayor que cero</div>');
            }
            $('input[name="revenue_multiple"], input[name="profit_multiple"]').val('');
            return false;
        }

        const revenueMultiple = (price / revenue).toFixed(2);
        const profitMultiple = (price / profit).toFixed(2);

        if (profitMultiple > maxMultiple || revenueMultiple > maxMultiple) {
            priceInput.removeClass('is-valid').addClass('is-invalid');
            priceInput.after(`
                <div class="feedback-message invalid-feedback">
                    El múltiplo no puede ser mayor a ${maxMultiple}x.
                    ${maxMultiple === 35 ? 'Para negocios con empleados.' : 'Para negocios sin empleados.'}
                    Recomendación: Ajuste el precio o las métricas.
                </div>
            `);
            return false;
        }

        $('input[name="revenue_multiple"]').val(revenueMultiple);
        $('input[name="profit_multiple"]').val(profitMultiple);

        priceInput.removeClass('is-invalid').addClass('is-valid');
        revenueInput.removeClass('is-invalid').addClass('is-valid');
        profitInput.removeClass('is-invalid').addClass('is-valid');

        revenueInput.after('<div class="feedback-message valid-feedback"><i class="fas fa-check"></i> Ingresos válidos</div>');
        profitInput.after(`<div class="feedback-message valid-feedback"><i class="fas fa-check"></i> Beneficio válido (${((profit/revenue)*100).toFixed(1)}% de los ingresos)</div>`);
        priceInput.after(`<div class="feedback-message valid-feedback"><i class="fas fa-check"></i> Múltiplos válidos: Ingresos ${revenueMultiple}x | Beneficios ${profitMultiple}x</div>`);

        return true;
    },

    setupImageValidation: function() {
        $('input[type="file"]').on('change', async function() {
            const files = this.files;
            const maxFiles = 5;
            const maxSize = 5 * 1024 * 1024; // 5MB
            const allowedTypes = ['image/jpeg', 'image/png'];

            if (files.length > maxFiles) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `Máximo ${maxFiles} archivos permitidos`
                });
                this.value = '';
                return;
            }

            for (let file of files) {
                if (file.size > maxSize) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: `El archivo ${file.name} excede el tamaño máximo permitido de 5MB`
                    });
                    this.value = '';
                    return;
                }

                if (!allowedTypes.includes(file.type)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: `El archivo ${file.name} debe ser JPG o PNG`
                    });
                    this.value = '';
                    return;
                }
            }
        });
    },

    setupImagePreview: function() {
        $('.custom-file-input').on('change', function() {
            const files = Array.from(this.files);
            const imagePreview = $('#imagePreview');
            imagePreview.html('');

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = `
                        <div class="image-preview-item">
                            <img src="${e.target.result}"
                                alt="Vista previa"
                                style="max-width: 200px; max-height: 200px; object-fit: cover;"/>
                            <div class="remove-image" data-index="${index}">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>`;
                    imagePreview.append(preview);
                };
                reader.readAsDataURL(file);
            });
        });

        $(document).on('click', '.remove-image', function() {
            const index = $(this).data('index');
            const input = $('.custom-file-input')[0];
            const dt = new DataTransfer();
            const { files } = input;

            for (let i = 0; i < files.length; i++) {
                if (i !== index) {
                    dt.items.add(files[i]);
                }
            }

            input.files = dt.files;
            $(this).closest('.image-preview-item').remove();

            $('.image-preview-item').each(function(newIndex) {
                $(this).find('.remove-image').data('index', newIndex);
            });
        });
    },

    validateCurrentStep: function() {
        const currentForm = $('#step' + this.currentStep);
        let isValid = true;

        currentForm.find('[required]').each(function() {
            if (!$(this).val()) {
                isValid = false;
                $(this).addClass('is-invalid');
            }
        });

        switch(this.currentStep) {
            case 1:
                isValid = this.validateStep1() && isValid;
                break;
            case 2:
                isValid = this.validateStep2() && isValid;
                break;
            case 3:
                isValid = this.validateStep3() && isValid;
                break;
            case 4:
                isValid = this.validateStep4() && isValid;
                break;
        }

        if (!isValid) {
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: 'Por favor complete todos los campos requeridos correctamente'
            });
        }

        return isValid;
    },

    validateStep1: function() {
    let isValid = true;
    const title = $('input[name="title"]');
    const description = $('textarea[name="description"]');
    const categoryId = $('#propertyType').val();

    if (title.val().length < 20 || title.val().length > 200) {
        isValid = false;
        this.showError(title, 'El título debe tener entre 20 y 200 caracteres');
    }

    if (description.val().length < 50 || description.val().length > 900) {
        isValid = false;
        this.showError(description, 'La descripción debe tener entre 50 y 900 caracteres');
    }

    if (categoryId) {
        const category = this.categories.find(c => c.id === parseInt(categoryId));
        const config = this.validationPatterns[categoryId];
        
        if (category && config) {
            const urlInput = $(`input[name="${category.type}_url"]`);
            if (!urlInput.val() || !config.pattern.test(urlInput.val().toLowerCase())) {
                isValid = false;
                this.showError(urlInput, `Por favor, ingresa una URL válida de ${config.name}`);
            }
        }
    }

    return isValid;
},

    validateStep2: function() {
        return this.updateMultipleValidation($('#has_employees').is(':checked') ? 35 : 25);
    },

    validateStep3: function() {
    const checkedTypes = $('input[name="monetization_types\\[\\]"]:checked');
    if (!checkedTypes.length) {
        Swal.fire({
            icon: 'error',
            title: 'Error de validación',
            text: 'Debe seleccionar al menos un tipo de monetización'
        });
        return false;
    }
    return true;
},



    validateStep4: function() {
        const images = $('input[name="asset_images[]"]')[0]?.files || [];
        if (images.length > 5) {
            Swal.fire({
                icon: 'error',
                title: 'Error de validación',
                text: 'Máximo 5 imágenes permitidas'
            });
            return false;
        }
        return true;
    },

    showError: function(element, message) {
        element.addClass('is-invalid');
        element.next('.invalid-feedback').remove();
        element.after(`<div class="invalid-feedback">${message}</div>`);
    },

    nextStep: function() {
        if (this.validateCurrentStep()) {
            if (this.currentStep < this.totalSteps) {
                this.currentStep++;
                this.showCurrentStep();
            } else {
                this.submitForm();
            }
        }
    },

    previousStep: function() {
        if (this.currentStep > 1) {
            this.currentStep--;
            this.showCurrentStep();
        }
    },

    showCurrentStep: function() {
        $('.step-content').hide();
        $('#step' + this.currentStep).show();

        const progress = (this.currentStep / this.totalSteps) * 100;
        $('.progress-bar').css('width', progress + '%');

        $('.step-badge').removeClass('badge-primary').addClass('badge-light');
        $('#stepBadge' + this.currentStep).removeClass('badge-light').addClass('badge-primary');

        $('#prevStepBtn').toggle(this.currentStep > 1);
        $('#nextStepBtn').html(
            this.currentStep === this.totalSteps ?
            '<i class="fas fa-paper-plane"></i> Publicar Anuncio' :
            'Siguiente <i class="fas fa-arrow-right"></i>'
        );
    },

    saveDraft: function() {
    const formData = new FormData($('#listingForm')[0]);
    formData.append('status', 'draft');
    formData.append('current_step', this.currentStep);
    
    // Eliminar archivos vacíos
    if (formData.get('employee_contracts[]').size === 0) {
        formData.delete('employee_contracts[]');
    }
    if (formData.get('payroll_docs[]').size === 0) {
        formData.delete('payroll_docs[]');
    }
    if (formData.get('asset_images[]').size === 0) {
        formData.delete('asset_images[]');
    }

    $.ajax({
        url: '/wp-content/themes/blocksy-child/trestiq-auth/dashboard/listings/listing-handler.php',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        beforeSend: function() {
            Swal.fire({
                title: 'Guardando borrador...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
        },
        success: function(response) {
            if (response.success) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Borrador guardado correctamente. Podrás continuar desde este punto más tarde.',
                    timer: 2000
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: response.message || 'Error al guardar el borrador'
                });
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Error al guardar el borrador. Por favor intenta nuevamente.'
            });
        }
    });
},

    submitForm: function() {
        if (this.validateCurrentStep()) {
            const formData = new FormData($('#listingForm')[0]);
            formData.append('status', 'active');
            console.log('Form data:', Object.fromEntries(formData));
            $.ajax({
                url: '/wp-content/themes/blocksy-child/trestiq-auth/dashboard/listings/listing-handler.php',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                beforeSend: function() {
                    Swal.fire({
                        title: 'Publicando anuncio...',
                        text: 'Por favor espere',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });
                },
                success: function(response) {
                    if (response.success) {
                        this.resetForm();
                        sessionStorage.setItem('formSubmitted', 'true');

                        Swal.fire({
                            icon: 'success',
                            title: '¡Éxito!',
                            text: 'Anuncio publicado correctamente',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(function() {
                            window.location.href = response.redirect_url;
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: response.message || 'Error al publicar el anuncio'
                        });
                    }
                }.bind(this),
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    console.log('Respuesta completa:', xhr.responseText);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Error de conexión: ' + (xhr.responseText || error)
                    });
                }
            });
        }
    }
};

// Inicialización cuando el documento está listo
$(document).ready(function() {
    TrestiqFormSteps.init();
});


</script> -->
</body>
</html>